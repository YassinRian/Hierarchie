SELECT 
  QY2.FPSB_DIM_BOEKSLEUTEL_ID
, QY2.FPSB_DIM_KDR_KPL_ORG_HIER_ID
, QY2.HR_NIVEAU
, QY2.ORGANISATIE_BK_KIND
, QY2.FPSB_REALISATIE_LASTEN
--
FROM
(
--    
-- QY2: QUERY LEVEL 2 // NODIG VOOR FILTERING OP HULPCALC
SELECT
--
 QY1.FPSB_DIM_GROOTBOEKPERIODE_ID 
,QY1.FPSB_DIM_KDR_KPL_ORG_HIER_ID
,QY1.FPSB_DIM_BOEKSLEUTEL_ID
,QY1.HR_NIVEAU
,QY1.ORGANISATIE_BK_KIND
,QY1.GBP_PERIODE_JAAR
,QY1.GBP_MAAND_NUMMER
,QY1.GBP_BEGINDATUM_PERIODE
,QY1.GBP_EINDDATUM_PERIODE
,QY1.GBP_CORRECTIEPERIODE_IND
,QY1.FPSB_DIM_DATUM_JAAR_ID
,QY1.FPSB_DIM_DIENST_ID
,QY1.FPSB_REALISATIE_BATEN
,QY1.FPSB_REALISATIE_LASTEN
,QY1.FPSB_OPENSTAANDE_VERPL
--
FROM
(
-- QY1: QUERY LEVEL 1 // NODIG VOOR HULPCALC
SELECT
COUNT(FPSB_DIM_GROOTBOEKPERIODE_ID) OVER (PARTITION BY FPSB_DIM_BOEKSLEUTEL_ID, GBP_PERIODE_JAAR, GBP_MAAND_NUMMER) COUNT_
,CASE
-- BIJ DE EERSTE CASE STATEMENT IS GBP_CORRECTIEPERIODE_IND ALTIJD 'NEE', ANDERS IS DIT EEN DATAKWALITEIT ISSUE 
WHEN COUNT(FPSB_DIM_GROOTBOEKPERIODE_ID) OVER (PARTITION BY FPSB_DIM_BOEKSLEUTEL_ID, GBP_PERIODE_JAAR, GBP_MAAND_NUMMER) = 1 then 1 
WHEN COUNT(FPSB_DIM_GROOTBOEKPERIODE_ID) OVER (PARTITION BY FPSB_DIM_BOEKSLEUTEL_ID, GBP_PERIODE_JAAR, GBP_MAAND_NUMMER) = 2 AND GBP_CORRECTIEPERIODE_IND = 'Ja' then 1 ELSE 0 END AS HULPCALC_CORRECTIEPERIODE_IND
,QY0.*
FROM
(
 -- QY0 -BRON QUERY LEVEL 1
select
 --
 FPSB.DIM_GROOTBOEKPERIODE_ID AS FPSB_DIM_GROOTBOEKPERIODE_ID
,FPSB.DIM_KDR_KPL_ORG_HIER_ID AS FPSB_DIM_KDR_KPL_ORG_HIER_ID
,FPSB.DIM_BOEKSLEUTEL_ID AS FPSB_DIM_BOEKSLEUTEL_ID
,GBP.PERIODE_JAAR AS GBP_PERIODE_JAAR
,extract(MONTH from GBP.BEGINDATUM_PERIODE) AS GBP_MAAND_NUMMER
,GBP.begindatum_periode as GBP_BEGINDATUM_PERIODE
,GBP.EINDDATUM_PERIODE AS GBP_EINDDATUM_PERIODE
,GBP.CORRECTIEPERIODE_IND AS GBP_CORRECTIEPERIODE_IND
,FPSB.DIM_DATUM_JAAR_ID AS FPSB_DIM_DATUM_JAAR_ID
,FPSB.DIM_DIENST_ID AS FPSB_DIM_DIENST_ID
,FPSB.REALISATIE_BATEN AS FPSB_REALISATIE_BATEN
,FPSB.REALISATIE_LASTEN AS FPSB_REALISATIE_LASTEN
,FPSB.VERPLICHTING AS FPSB_OPENSTAANDE_VERPL
,KPLKDR.HR_NIVEAU
,KPLKDR.ORGANISATIE_BK_KIND
--
from dmt.fct_balansregels_psb FPSB 
inner join dmt.DIM_KDR_KPL_ORG_HIER KPLKDR on FPSB.DIM_KDR_KPL_ORG_HIER_ID = KPLKDR.DIM_KDR_KPL_ORG_HIER_ID 
inner join dmt.dim_grootboekperiode GBP on FPSB.dim_grootboekperiode_id = GBP.dim_grootboekperiode_id
where dim_dienst_id = 65 
) QY0
ORDER BY GBP_MAAND_NUMMER
) QY1
WHERE QY1.HULPCALC_CORRECTIEPERIODE_IND = 1 
AND QY1.HR_NIVEAU IS NOT NULL 
AND QY1.ORGANISATIE_BK_KIND = 4294
AND QY1.GBP_MAAND_NUMMER = 9
--
) QY2
ORDER BY QY2.FPSB_DIM_BOEKSLEUTEL_ID