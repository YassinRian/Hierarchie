-- vergeet niet HR_NIVEAU_TOP te verwerken in alle sommen als het gaat om optellen van facturen ( want facturen worden gedupliceerd over de verschillende levels)
WITH 
CHILD_LEVEL AS 
(SELECT DIM_KDR_KPL_ORG_HIER_ID, KOSTENDRAGER_KIND, ORGANISATIE_BK_VADER, ORGANISATIE_KIND, ORGANISATIE_BK_KIND, HR_NIVEAU FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC WHERE KOSTENDRAGER_KIND LIKE 'B6%'),
HIERARCHIE AS (
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL0.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, TO_NUMBER('') AS LVL1
, '' AS ORGANISATIE_LVL1
, TO_NUMBER('') AS LVL2
, '' AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
WHERE KOSTENDRAGER_KIND LIKE 'B6%' 
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL1.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL1.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL1.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, TO_NUMBER('') AS LVL2
, '' AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0 
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%' 
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL2.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL2.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL2.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%' 
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL3.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL3.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL3.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%' 
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL4.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL4.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL4.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL5.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL5.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL5.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, LVL5.ORGANISATIE_BK_KIND AS LVL5
, LVL5.ORGANISATIE_KIND AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL5 ON LVL4.ORGANISATIE_BK_KIND = LVL5.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%' 
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENDRAGER_KIND AS KOSTENDRAGER_TOP
, LVL6.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL6.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL6.KOSTENDRAGER_KIND AS KOSTENDRAGER_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, LVL5.ORGANISATIE_BK_KIND AS LVL5
, LVL5.ORGANISATIE_KIND AS ORGANISATIE_LVL5
, LVL6.ORGANISATIE_BK_KIND AS LVL6
, LVL6.ORGANISATIE_KIND AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL5 ON LVL4.ORGANISATIE_BK_KIND = LVL5.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL6 ON LVL5.ORGANISATIE_BK_KIND = LVL6.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENDRAGER_KIND LIKE 'B6%' 
)
SELECT * FROM
(
SELECT 
CASE WHEN COUNT_ > 1 THEN ROW_NUMBER() OVER (PARTITION BY COUNT_ ORDER BY COUNT_) ELSE 1 END VERWIJDEREN_DUPS
,QY0.*
FROM
(
SELECT
COUNT(FCT_FAC.DIM_FACTUUR_ID) OVER (PARTITION BY FCT_FAC.DIM_FACTUUR_ID, HIERARCHIE.KPLKDR_ID_TOP, FCT_FAC.DIM_GROOTBOEKPERIODE_ID) AS COUNT_
,Hierarchie.KPLKDR_ID_TOP
,Hierarchie.HR_NIVEAU_TOP
,Hierarchie.KOSTENDRAGER_TOP
,cast(NULL as varchar2(255)) AS KOSTENPLAATS_TOP
,Hierarchie.KPLKDR_ID_CHILD
,Hierarchie.HR_NIVEAU_CHILD
,Hierarchie.KOSTENDRAGER_CHILD
,Hierarchie.LVL_T
,Hierarchie.ORGANISATIE_TOP
,Hierarchie.LVL1
,Hierarchie.ORGANISATIE_LVL1
,Hierarchie.LVL2
,Hierarchie.ORGANISATIE_LVL2
,Hierarchie.LVL3
,Hierarchie.ORGANISATIE_LVL3
,Hierarchie.LVL4
,Hierarchie.ORGANISATIE_LVL4
,Hierarchie.LVL5
,Hierarchie.ORGANISATIE_LVL5
,Hierarchie.LVL6
,Hierarchie.ORGANISATIE_LVL6
,FCT_FAC.DIM_FACTUUR_ID
,FCT_FAC.DIM_GROOTBOEKPERIODE_ID
,FCT_FAC.DIM_KDR_KPL_ORG_HIER_ID
,FCT_FAC.DIM_DIENST_ID
,FCT_FAC.DIM_DATUM_FACTUUR_ID
,FCT_FAC.DIM_LEVERANCIER_ID
,EXTRACT(YEAR FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AS JAAR
,EXTRACT(MONTH FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AS MAAND_NUMMER
,INITCAP(LOWER(TO_CHAR(COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM), 'MON', 'NLS_DATE_LANGUAGE=DUTCH'))) AS MAAND_NAAM
,INITCAP(LOWER(TO_CHAR(COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM), 'DD-MON', 'NLS_DATE_LANGUAGE=DUTCH'))) AS DD_MON 
,DT.MAAND_VOLGNUMMER
,FAC.FACTUURNUMMER
,FAC.AFGESLOTEN_IND
,FAC.BETAALSTATUS
,FAC.FACTUURDATUM
,FAC.ONTVANGSTDATUM
,FAC.SCANDATUM
,FAC.AANMAAKDATUM
,FAC.LAATSTE_BETAALDATUM
,FCT_FAC.AANTAL_DAGEN_OPENSTAAND
,FAC.FACTUUR_MATCH_INKOOPORDER_IND
,FAC.GROOTBOEKDATUM 
,FAC.BETAALTERMIJNDATUM
,FAC.LAATSTE_TERMIJNVERVALDATUM
,COALESCE(FAC.ONTVANGSTDATUM,FAC.FACTUURDATUM) + 30 AS VANAF_30_DGN
,CASE WHEN CURRENT_DATE <= ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN 'NVIN' ELSE NULL END AS FACTUREN_IN_30DGN_NVIN 
,CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN 'NVNA' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA 
,CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM <= ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN 'VIN' ELSE NULL END AS FACTUREN_IN_30DGN_VIN
,CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN 'VNA' ELSE NULL END AS FACTUREN_NA_30DGN_VNA 
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'NVNA_0_7' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_0_7  
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - (COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) BETWEEN 8 AND 14 THEN 'NVNA_8_14' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_8_14  
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - (COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) > 14 THEN 'NVNA_G_14' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_G_14  
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'VNA_0_7' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_0_7
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) BETWEEN 8 AND 14 THEN 'VNA_8_14' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_8_14 
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'VNA_G_14' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_G_14 
FROM DMT.FCT_FACTUREN_DIENSTEN@EBS_ORACLE_1FA_ACC FCT_FAC 
INNER JOIN DMT.DIM_FACTUUR@EBS_ORACLE_1FA_ACC FAC ON FCT_FAC.DIM_FACTUUR_ID = FAC.DIM_FACTUUR_ID
INNER JOIN DMT.DIM_LEVERANCIER@EBS_ORACLE_1FA_ACC LEV ON FCT_FAC.DIM_LEVERANCIER_ID = LEV.DIM_LEVERANCIER_ID
INNER JOIN HIERARCHIE ON HIERARCHIE.KPLKDR_ID_CHILD = FCT_FAC.DIM_KDR_KPL_ORG_HIER_ID 
INNER JOIN ( SELECT DISTINCT JAAR, MAANDNUMMER, MAAND_VOLGNUMMER FROM DMT.DIM_DATUM@EBS_ORACLE_1FA_ACC WHERE JAAR BETWEEN (EXTRACT(YEAR FROM CURRENT_DATE) - 5) AND EXTRACT(YEAR FROM CURRENT_DATE) ) DT ON DT.JAAR =  EXTRACT(YEAR FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AND DT.MAANDNUMMER = EXTRACT(MONTH FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM))
WHERE DIM_DIENST_ID = 6 and HR_NIVEAU_CHILD IS NOT NULL and LEV.LEVERANCIERSOORT = 'Cred. Overig'
)QY0
)
WHERE VERWIJDEREN_DUPS = 1
UNION ALL
SELECT * FROM
(
WITH 
CHILD_LEVEL AS 
(SELECT DIM_KDR_KPL_ORG_HIER_ID, KOSTENPLAATS_KIND, ORGANISATIE_BK_VADER, ORGANISATIE_KIND, ORGANISATIE_BK_KIND, HR_NIVEAU FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC WHERE KOSTENPLAATS_KIND LIKE 'B5%'),
DATUM AS
(SELECT DISTINCT JAAR, MAANDNUMMER, MAAND_VOLGNUMMER FROM DMT.DIM_DATUM@EBS_ORACLE_1FA_ACC WHERE JAAR BETWEEN (EXTRACT(YEAR FROM CURRENT_DATE) - 5) AND EXTRACT(YEAR FROM CURRENT_DATE)),
HIERARCHIE AS (
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL0.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, TO_NUMBER('') AS LVL1
, '' AS ORGANISATIE_LVL1
, TO_NUMBER('') AS LVL2
, '' AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
WHERE KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL1.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL1.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL1.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, TO_NUMBER('') AS LVL2
, '' AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0 
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL2.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL2.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL2.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, TO_NUMBER('') AS LVL3
, '' AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL3.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL3.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL3.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, TO_NUMBER('') AS LVL4
, '' AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL4.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL4.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL4.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, TO_NUMBER('') AS LVL5
, '' AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL5.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL5.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL5.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, LVL5.ORGANISATIE_BK_KIND AS LVL5
, LVL5.ORGANISATIE_KIND AS ORGANISATIE_LVL5
, TO_NUMBER('') AS LVL6
, '' AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL5 ON LVL4.ORGANISATIE_BK_KIND = LVL5.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
UNION ALL
SELECT 
  LVL0.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_TOP
, LVL0.HR_NIVEAU AS HR_NIVEAU_TOP
, LVL0.KOSTENPLAATS_KIND AS KOSTENPLAATS_TOP
, LVL6.DIM_KDR_KPL_ORG_HIER_ID AS KPLKDR_ID_CHILD
, LVL6.HR_NIVEAU AS HR_NIVEAU_CHILD
, LVL6.KOSTENPLAATS_KIND AS KOSTENPLAATS_CHILD
, LVL0.ORGANISATIE_BK_KIND AS LVL_T 
, LVL0.ORGANISATIE_KIND AS ORGANISATIE_TOP
, LVL1.ORGANISATIE_BK_KIND AS LVL1
, LVL1.ORGANISATIE_KIND AS ORGANISATIE_LVL1
, LVL2.ORGANISATIE_BK_KIND AS LVL2
, LVL2.ORGANISATIE_KIND AS ORGANISATIE_LVL2
, LVL3.ORGANISATIE_BK_KIND AS LVL3
, LVL3.ORGANISATIE_KIND AS ORGANISATIE_LVL3
, LVL4.ORGANISATIE_BK_KIND AS LVL4
, LVL4.ORGANISATIE_KIND AS ORGANISATIE_LVL4
, LVL5.ORGANISATIE_BK_KIND AS LVL5
, LVL5.ORGANISATIE_KIND AS ORGANISATIE_LVL5
, LVL6.ORGANISATIE_BK_KIND AS LVL6
, LVL6.ORGANISATIE_KIND AS ORGANISATIE_LVL6
FROM DMT.DIM_KDR_KPL_ORG_HIER@EBS_ORACLE_1FA_ACC LVL0
INNER JOIN CHILD_LEVEL LVL1 ON LVL0.ORGANISATIE_BK_KIND = LVL1.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL2 ON LVL1.ORGANISATIE_BK_KIND = LVL2.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL3 ON LVL2.ORGANISATIE_BK_KIND = LVL3.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL4 ON LVL3.ORGANISATIE_BK_KIND = LVL4.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL5 ON LVL4.ORGANISATIE_BK_KIND = LVL5.ORGANISATIE_BK_VADER 
INNER JOIN CHILD_LEVEL LVL6 ON LVL5.ORGANISATIE_BK_KIND = LVL6.ORGANISATIE_BK_VADER 
WHERE LVL0.KOSTENPLAATS_KIND LIKE 'B5%'
)
SELECT * FROM
(
SELECT 
CASE WHEN COUNT_ > 1 THEN ROW_NUMBER() OVER (PARTITION BY COUNT_ ORDER BY COUNT_) ELSE 1 END VERWIJDEREN_DUPS
,QY0.*
FROM
(
SELECT
 COUNT(FCT_FAC.DIM_FACTUUR_ID) OVER (PARTITION BY FCT_FAC.DIM_FACTUUR_ID, HIERARCHIE.KPLKDR_ID_TOP, FCT_FAC.DIM_GROOTBOEKPERIODE_ID) AS COUNT_
,Hierarchie.KPLKDR_ID_TOP
,Hierarchie.HR_NIVEAU_TOP
,cast(NULL as varchar2(255)) AS KOSTENDRAGER_TOP
,Hierarchie.KOSTENPLAATS_TOP
,Hierarchie.KPLKDR_ID_CHILD
,Hierarchie.HR_NIVEAU_CHILD
,Hierarchie.KOSTENPLAATS_CHILD
,Hierarchie.LVL_T
,Hierarchie.ORGANISATIE_TOP
,Hierarchie.LVL1
,Hierarchie.ORGANISATIE_LVL1
,Hierarchie.LVL2
,Hierarchie.ORGANISATIE_LVL2
,Hierarchie.LVL3
,Hierarchie.ORGANISATIE_LVL3
,Hierarchie.LVL4
,Hierarchie.ORGANISATIE_LVL4
,Hierarchie.LVL5
,Hierarchie.ORGANISATIE_LVL5
,Hierarchie.LVL6
,Hierarchie.ORGANISATIE_LVL6
,FCT_FAC.DIM_FACTUUR_ID
,FCT_FAC.DIM_GROOTBOEKPERIODE_ID
,FCT_FAC.DIM_KDR_KPL_ORG_HIER_ID
,FCT_FAC.DIM_DIENST_ID
,FCT_FAC.DIM_DATUM_FACTUUR_ID
,FCT_FAC.DIM_LEVERANCIER_ID
,EXTRACT(YEAR FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AS JAAR
,EXTRACT(MONTH FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AS MAAND_NUMMER
,INITCAP(LOWER(TO_CHAR(COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM), 'MON', 'NLS_DATE_LANGUAGE=DUTCH'))) AS MAAND_NAAM
,INITCAP(LOWER(TO_CHAR(COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM), 'DD-MON', 'NLS_DATE_LANGUAGE=DUTCH'))) AS DD_MON 
,DT.MAAND_VOLGNUMMER
,FAC.FACTUURNUMMER
,FAC.AFGESLOTEN_IND
,FAC.BETAALSTATUS
,FAC.FACTUURDATUM
,FAC.ONTVANGSTDATUM
,FAC.SCANDATUM
,FAC.AANMAAKDATUM
,FAC.LAATSTE_BETAALDATUM
,FCT_FAC.AANTAL_DAGEN_OPENSTAAND
,FAC.FACTUUR_MATCH_INKOOPORDER_IND
,FAC.GROOTBOEKDATUM 
,FAC.BETAALTERMIJNDATUM
,FAC.LAATSTE_TERMIJNVERVALDATUM
,COALESCE(FAC.ONTVANGSTDATUM,FAC.FACTUURDATUM) + 30 AS VANAF_30_DGN
,CASE WHEN CURRENT_DATE <= ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN 'NVIN' ELSE NULL END AS FACTUREN_IN_30DGN_NVIN -- NVIN: Niet voldaan (30 dagen nog niet voorbij)
,CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN 'NVNA' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA -- NVNA: Niet voldaan (Na 30 dagen voorbij)
,CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM <= ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN 'VIN' ELSE NULL END AS FACTUREN_IN_30DGN_VIN -- VIN: Voldaan binnen 30 dagen 
,CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN 'VNA' ELSE NULL END AS FACTUREN_NA_30DGN_VNA -- VNA: Voldaan na 30 dagen 
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'NV_0_7' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_0_7  -- Niet Voldaan en factuur is tussen 0 en 7 dagen te laat 
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) BETWEEN 8 AND 14 THEN 'NV_8_14' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_8_14 -- Niet Voldaan en factuur is tussen 8 en 14 dagen te laat 
,CASE WHEN (CASE WHEN CURRENT_DATE > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) AND FAC.AFGESLOTEN_IND = 'Nee' THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) > 14 THEN 'NV_G_14' ELSE NULL END AS FACTUREN_NA_30DGN_NVNA_G_14 -- Niet Voldaan en factuur is al meer dan 14 dagen te laat 
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'V_0_7' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_0_7 -- Voldaan, maar te laat voldaan tussen 0 en 7 dagen
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) BETWEEN 8 AND 14 THEN 'V_8_14' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_8_14 -- Voldaan, maar te laat voldaan tussen 8 en 14 dagen
,CASE WHEN (CASE WHEN FAC.LAATSTE_BETAALDATUM <= CURRENT_DATE AND FAC.LAATSTE_BETAALDATUM > ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) THEN CURRENT_DATE - ( COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM) + 30) ELSE NULL END) <= 7 THEN 'V_G_14' ELSE NULL END AS FACTUREN_NA_30DGN_VNA_G_14 -- Voldaan, maar te laat voldaan en voldaan na 14 dagen over tijd
FROM DMT.FCT_FACTUREN_DIENSTEN@EBS_ORACLE_1FA_ACC FCT_FAC 
INNER JOIN DMT.DIM_FACTUUR@EBS_ORACLE_1FA_ACC FAC ON FCT_FAC.DIM_FACTUUR_ID = FAC.DIM_FACTUUR_ID
INNER JOIN DMT.DIM_LEVERANCIER@EBS_ORACLE_1FA_ACC LEV ON FCT_FAC.DIM_LEVERANCIER_ID = LEV.DIM_LEVERANCIER_ID
INNER JOIN HIERARCHIE ON HIERARCHIE.KPLKDR_ID_CHILD = FCT_FAC.DIM_KDR_KPL_ORG_HIER_ID 
INNER JOIN DATUM DT ON DT.JAAR =  EXTRACT(YEAR FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM)) AND DT.MAANDNUMMER = EXTRACT(MONTH FROM COALESCE(FAC.ONTVANGSTDATUM, FAC.FACTUURDATUM))
WHERE DIM_DIENST_ID = 6 and HR_NIVEAU_CHILD IS NOT NULL and LEV.LEVERANCIERSOORT = 'Cred. Overig'
)QY0
)
WHERE VERWIJDEREN_DUPS = 1
)